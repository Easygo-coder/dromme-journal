<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dr√∏mme Journal</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dr√∏mme Journal">
    <meta name="theme-color" content="#4CAF50">
    
    <style>
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f8ff;
        }

        .dream-form, .dream-list, .analysis {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .dream-entry {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        textarea {
            width: calc(100% - 24px);
            height: 120px;
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin: 10px 0;
            transition: background-color 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .delete-btn {
            background: #ff4444;
            width: auto;
        }

        .delete-btn:hover {
            background: #cc0000;
        }

        input[type="date"], select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            background-color: white;
        }

        .analysis {
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
            margin-top: 15px;
            font-size: 15px;
            line-height: 1.6;
        }

        .dream-illustration {
            background: #f1f8e9;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-style: italic;
        }

        .illustration-header {
            color: #2E7D32;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .dream-image {
            margin: 15px 0;
            text-align: center;
        }

        .dream-image img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .offline-indicator {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            text-align: center;
            padding: 10px;
            display: none;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .dream-form, .dream-list, .analysis {
                padding: 15px;
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dream-form">
            <h2>Skriv din dr√∏m</h2>
            <div>
                <label for="dreamDate">Dato:</label>
                <input type="date" id="dreamDate" required>
            </div>
            <div>
                <label for="dreamText">Beskriv din dr√∏m:</label>
                <textarea id="dreamText" placeholder="Beskriv din dr√∏m her... Jo flere detaljer, jo bedre analyse" required></textarea>
            </div>
            <div>
                <label for="dreamMood">Hvordan var dr√∏mmen?</label>
                <select id="dreamMood">
                    <option value="happy">üòä Glad dr√∏m</option>
                    <option value="neutral">üòê Neutral dr√∏m</option>
                    <option value="scary">üò® Uhyggelig dr√∏m</option>
                </select>
            </div>
            <button onclick="addDream()">Gem dr√∏m og analys√©r</button>
        </div>

        <div class="dream-list">
            <h2>Mine dr√∏mme</h2>
            <div id="dreams"></div>
        </div>
    </div>

    <div class="offline-indicator" id="offlineIndicator">
        Du er offline - √¶ndringer gemmes n√•r du er online igen
    </div>

    <script>
        // Tematiske kategorier og deres relaterede koncepter
        const dreamThemes = {
            social: {
                keywords: ['sammen', 'm√∏de', 'tale', 'snakke', 'personer', 'mennesker', 'venner', 'familie'],
                analysis: 'Din dr√∏m afspejler dine sociale relationer og hvordan du forholder dig til andre mennesker.',
                insight: 'Overvej kvaliteten af dine relationer og hvordan du kommunikerer med andre.'
            },
            growth: {
                keywords: ['ny', 'udvikling', 'l√¶re', 'pr√∏ve', 'udfordring', 'k√¶mpe', 'fors√∏ge'],
                analysis: 'Der er fokus p√• personlig v√¶kst og udvikling i din dr√∏m.',
                insight: 'Du er muligvis i en periode med personlig transformation eller l√¶ring.'
            },
            emotional: {
                keywords: ['f√∏le', 'bange', 'glad', 'ked', 'vred', 'nerv√∏s', 'rolig'],
                analysis: 'Dr√∏mmen udtrykker st√¶rke f√∏lelsesm√¶ssige temaer.',
                insight: 'V√¶r opm√¶rksom p√• dine f√∏lelser og hvordan du h√•ndterer dem.'
            },
            environment: {
                keywords: ['sted', 'rum', 'bygning', 'natur', 'by', 'omr√•de', 'lokation'],
                analysis: 'Omgivelserne i din dr√∏m kan repr√¶sentere din livssituation eller sindstilstand.',
                insight: 'T√¶nk over hvordan du har det i dine nuv√¶rende omgivelser.'
            }
        };
        function analyzeContext(text) {
            const cleanText = text.toLowerCase()
                .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
                .replace(/\s{2,}/g, ' ');

            const themes = [];
            for (const [theme, data] of Object.entries(dreamThemes)) {
                const themeScore = data.keywords.reduce((score, keyword) => {
                    return score + (cleanText.includes(keyword) ? 1 : 0);
                }, 0);
                if (themeScore > 0) {
                    themes.push({ theme, score: themeScore, data });
                }
            }

            return generateContextAnalysis(themes, text);
        }

        function generateContextAnalysis(themes, originalText) {
            if (themes.length === 0) {
                return generateGeneralAnalysis(originalText);
            }

            themes.sort((a, b) => b.score - a.score);
            
            return formatThematicAnalysis(themes, originalText);
        }

        function generateGeneralAnalysis(text) {
            const wordCount = text.split(' ').length;
            const hasAction = /\b(g√∏r|g√•r|kommer|tager|ser)\b/i.test(text);
            const hasPeople = /\b(person|menneske|folk|nogen|han|hun|de)\b/i.test(text);
            const hasLocations = /\b(sted|rum|hus|bygning|by|omr√•de)\b/i.test(text);

            let analysis = "Din dr√∏m virker ";
            
            if (wordCount > 100) {
                analysis += "meget detaljeret, hvilket kan indikere en betydningsfuld oplevelse. ";
            } else if (wordCount > 50) {
                analysis += "velovervejet og sammenh√¶ngende. ";
            } else {
                analysis += "koncis og fokuseret. ";
            }

            if (hasAction) {
                analysis += "\n\nDer er handling og bev√¶gelse i dr√∏mmen, hvilket ofte afspejler en proces af forandring eller udvikling i dit liv. ";
            }

            if (hasPeople) {
                analysis += "\n\nTilstedev√¶relsen af andre i dr√∏mmen kan pege p√• vigtige relationer eller aspekter af dig selv. ";
            }

            if (hasLocations) {
                analysis += "\n\nDe beskrevne steder eller omgivelser kan repr√¶sentere forskellige omr√•der af dit liv eller din psyke. ";
            }

            analysis += "\n\nRefleksionspunkter:\n";
            analysis += "‚Ä¢ Hvilke f√∏lelser efterlod dr√∏mmen dig med?\n";
            analysis += "‚Ä¢ Er der elementer i dr√∏mmen der minder dig om aktuelle situationer i dit liv?\n";
            analysis += "‚Ä¢ Hvad er det f√∏rste der falder dig ind, n√•r du t√¶nker p√• dr√∏mmen?\n";
            analysis += "‚Ä¢ Er der noget i dr√∏mmen der overraskede dig?";

            return analysis;
        }

        function formatThematicAnalysis(themes, originalText) {
            let analysis = `Din dr√∏m indeholder interessante temaer:\n\n`;
            
            themes.forEach(theme => {
                analysis += `${theme.data.analysis}\n`;
                analysis += `${theme.data.insight}\n\n`;
            });

            return analysis;
        }

        function analyzeMood(mood) {
            switch(mood) {
                case 'happy':
                    return "\n\nDen positive stemning i dr√∏mmen kan indikere en periode med optimisme eller personlig udvikling.";
                case 'scary':
                    return "\n\nDen urolige stemning kan pege p√• underliggende bekymringer eller udfordringer der s√∏ger din opm√¶rksomhed.";
                case 'neutral':
                    return "\n\nDen neutrale stemning kan indikere en periode med reflektion eller observation i dit liv.";
                default:
                    return "\n\nDr√∏mmens stemning er en vigtig n√∏gle til at forst√• dens personlige betydning for dig.";
            }
        }
        let dreams = [];
        
        // Initialize app
        window.onload = function() {
            const today = new Date();
            const dateInput = document.getElementById('dreamDate');
            if (dateInput) {
                dateInput.valueAsDate = today;
            }
            loadFromLocalStorage();
            updateOnlineStatus();
        };

        async function addDream() {
    const dreamText = document.getElementById('dreamText').value.trim();
    const dreamDate = document.getElementById('dreamDate').value;
    const dreamMood = document.getElementById('dreamMood').value;
    
    if (!dreamText || !dreamDate) {
        alert('Udfyld venligst b√•de dato og dr√∏mmebeskrivelse');
        return;
    }
    
    // Vis loading state
    const submitButton = document.querySelector('button');
    submitButton.disabled = true;
    submitButton.textContent = 'Analyserer dr√∏m og genererer billede...';
    
    try {
        const response = await fetch('/.netlify/functions/generateImage', {
            method: 'POST',
            body: JSON.stringify({ dreamText, mood: dreamMood }),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }

        const newDream = {
            text: dreamText,
            date: dreamDate,
            mood: dreamMood,
            analysis: data.analysis,
            imageUrl: data.imageUrl,
            id: Date.now()
        };
        
        dreams.unshift(newDream);
        saveToLocalStorage();
        
        document.getElementById('dreamText').value = '';
        const dateInput = document.getElementById('dreamDate');
        if (dateInput) {
            dateInput.valueAsDate = new Date();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Der opstod en fejl under analysen. Pr√∏v igen.');
    } finally {
        // Reset button
        submitButton.disabled = false;
        submitButton.textContent = 'Gem dr√∏m og analys√©r';
        updateDreamsList();
    }
}

        async function addDream() {
            const dreamText = document.getElementById('dreamText').value.trim();
            const dreamDate = document.getElementById('dreamDate').value;
            const dreamMood = document.getElementById('dreamMood').value;
            
            if (!dreamText || !dreamDate) {
                alert('Udfyld venligst b√•de dato og dr√∏mmebeskrivelse');
                return;
            }
            
            // Show loading state
            const submitButton = document.querySelector('button');
            submitButton.disabled = true;
            submitButton.textContent = 'Genererer dr√∏mmeanalyse og billede...';
            
            const analysis = analyzeContext(dreamText) + analyzeMood(dreamMood);
            let imageUrl = null;
            
            try {
                imageUrl = await generateDreamImage(dreamText);
            } catch (error) {
                console.error('Kunne ikke generere billede:', error);
            }
            
            const newDream = {
                text: dreamText,
                date: dreamDate,
                mood: dreamMood,
                analysis: analysis,
                imageUrl: imageUrl,
                id: Date.now()
            };
            
            dreams.unshift(newDream);
            saveToLocalStorage();
            
            document.getElementById('dreamText').value = '';
            const dateInput = document.getElementById('dreamDate');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
            
            // Reset button
            submitButton.disabled = false;
            submitButton.textContent = 'Gem dr√∏m og analys√©r';
            
            updateDreamsList();
        }

        function saveToLocalStorage() {
            localStorage.setItem('dreams', JSON.stringify(dreams));
        }

        function loadFromLocalStorage() {
            const savedDreams = localStorage.getItem('dreams');
            if (savedDreams) {
                dreams = JSON.parse(savedDreams);
                updateDreamsList();
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (!navigator.onLine) {
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        function deleteDream(id) {
            if (confirm('Er du sikker p√•, at du vil slette denne dr√∏m?')) {
                dreams = dreams.filter(dream => dream.id !== id);
                saveToLocalStorage();
                updateDreamsList();
            }
        }

        function updateDreamsList() {
    const dreamsDiv = document.getElementById('dreams');
    if (!dreamsDiv) return;

    if (dreams.length === 0) {
        dreamsDiv.innerHTML = '<p>Du har ikke gemt nogen dr√∏mme endnu.</p>';
        return;
    }
    
    dreamsDiv.innerHTML = dreams.map(dream => `
        <div class="dream-entry">
            <strong>${new Date(dream.date).toLocaleDateString('da-DK')}</strong>
            <span class="mood-icon">
                ${dream.mood === 'happy' ? 'üòä' : dream.mood === 'neutral' ? 'üòê' : 'üò®'}
            </span>
            <p>${dream.text}</p>
            <div class="dream-image">
                ${dream.imageUrl ? `
                    <img src="${dream.imageUrl}" alt="Visualisering af dr√∏mmen" 
                         style="width: 100%; max-width: 512px; border-radius: 8px; margin: 10px 0;">
                    <button onclick="generateNewImage(${dream.id})" class="regenerate-btn">
                        üé® Generer ny visualisering
                    </button>
                ` : ''}
            </div>
            <div class="analysis">
                <h4>Dr√∏mmeanalyse:</h4>
                <div class="theme-section">${dream.analysis}</div>
            </div>
            <button class="delete-btn" onclick="deleteDream(${dream.id})">Slet dr√∏m</button>
        </div>
    `).join('');
}
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registered');
                }).catch(err => {
                    console.log('ServiceWorker registration failed', err);
                });
            });
        }
    </script>
</body>
</html>
